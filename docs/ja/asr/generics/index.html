
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Generics &#8212; LFortran</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/ansi.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/translations.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../_static/lfortran-logo.svg"/>
    <link rel="index" title="索引" href="../../genindex/" />
    <link rel="search" title="検索" href="../../search/" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=amber data-md-color-accent=orange>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#asr/generics" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../" title="LFortran"
           class="md-header-nav__button md-logo">
          
              <img src="../../_static/lfortran-logo.svg" height="26"
                   alt="LFortran logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">LFortran Documentation</span>
          <span class="md-header-nav__topic"> Generics </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search/" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/lfortran/lfortran" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LFortran
  </div>
</a>
          </div>
        </div>
      
      
  
  <div class="md-flex__cell md-flex__cell--shrink dropdown">
    <button class="dropdownbutton">Versions</button>
    <div class="dropdown-content md-hero">
          <a title="English" href="/../en/">English</a>
      
          <a title="Bengali" href="/../bn/">Bengali</a>
      
          <a title="Czech" href="/../cs/">Czech</a>
      
          <a title="German" href="/../de/">German</a>
      
          <a title="Spanish" href="/../es/">Spanish</a>
      
          <a title="French" href="/../fr/">French</a>
      
          <a title="Japanese" href="/../ja/">Japanese</a>
      
          <a title="Dutch" href="/../nl/">Dutch</a>
      
          <a title="Polish" href="/../pl/">Polish</a>
      
          <a title="Portuguese" href="/../pt/">Portuguese</a>
      
          <a title="Russian" href="/../ru/">Russian</a>
      
          <a title="Chinese" href="/../zh_CN/">Chinese</a>
      
    </div>
  </div>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../" class="md-tabs__link">LFortran</a></li>
            
            <li class="md-tabs__item"><a href="../../installation/" class="md-tabs__link">Getting started</a></li>
            
            <li class="md-tabs__item"><a href="../../progress/" class="md-tabs__link">LFortran Development Status</a></li>
            
            <li class="md-tabs__item"><a href="../../design/" class="md-tabs__link">Developers's Guide</a></li>
            
            <li class="md-tabs__item"><a href="../../intrinsics/array/" class="md-tabs__link">Intrinsics</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../" title="LFortran" class="md-nav__button md-logo">
      
        <img src="../../_static/lfortran-logo.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../"
       title="LFortran">LFortran Documentation</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/lfortran/lfortran" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LFortran
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Getting started</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../installation/" class="md-nav__link">Installation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../language/" class="md-nav__link">Fortran Language</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../usage/" class="md-nav__link">LFortran User Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">LFortran Development Status</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../progress/" class="md-nav__link">LFortran Development Status</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../progress/#topics" class="md-nav__link">Topics</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Developer's Guide</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../design/" class="md-nav__link">LFortran Design</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../developer_tutorial/" class="md-nav__link">Developer Tutorial</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../ast_and_asr/" class="md-nav__link">Difference between an AST and ASR</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../contributing/" class="md-nav__link">Contributing</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">LFortran Intrinsics</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/array/" class="md-nav__link">Array Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/bit/" class="md-nav__link">Bit Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/character/" class="md-nav__link">Character Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/kind-type/" class="md-nav__link">Kind Type Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/mathematical/" class="md-nav__link">Mathematical Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/numeric/" class="md-nav__link">Numeric Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../intrinsics/misc/" class="md-nav__link">Miscellaneous Intrinsic Functions</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">LFortran ASR Nodes</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/cast_kind_nodes/cast_kind/" class="md-nav__link">cast_kind</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/expression_nodes/expression_nodes/" class="md-nav__link">ASR Expression Nodes</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/kinds_nodes/kinds/" class="md-nav__link">kinds</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/statement_nodes/statement_nodes/" class="md-nav__link">ASR Statement Nodes</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/symbol_nodes/symbol_nodes/" class="md-nav__link">ASR Symbol Nodes</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../asr_nodes/type_nodes/ttype/" class="md-nav__link">ttype</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#asr-generics--page-root" class="md-nav__link">Generics</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#requirements" class="md-nav__link">Requirements</a>
        </li>
        <li class="md-nav__item"><a href="#templates" class="md-nav__link">Templates</a>
        </li>
        <li class="md-nav__item"><a href="#instantiations" class="md-nav__link">Instantiations</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#type-checking" class="md-nav__link">Type Checking</a>
        </li>
        <li class="md-nav__item"><a href="#asr-generation" class="md-nav__link">ASR Generation</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#see-also" class="md-nav__link">See Also</a>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="generics">
<h1 id="asr-generics--page-root">Generics<a class="headerlink" href="#asr-generics--page-root" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>From a high-level perspective generics are supported in LFortran by three main elements:</p>
<ol class="arabic simple">
<li><p><strong>Requirements</strong> declaring deferred types and their abstract functions</p></li>
<li><p><strong>Templates</strong> implementing generic symbols (functions, subroutines, derived types) using deferred types and abstract functions described by requirements</p></li>
<li><p><strong>Instantiations</strong> by passing concrete types and functions into templates</p></li>
</ol>
<section id="requirements">
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Requirements declare deferred types (generic types) and its associated functions, similar to <em>typeclasses</em> in Haskell and <em>traits</em> in Rust. For example, the signature for a generic monoid of any type can be represented by the following requirement:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">requirement</span><span class="w"> </span><span class="n">monoid</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">)</span>
<span class="w">  </span><span class="c">! declaring a deferred type (generic type)</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">deferred</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">T</span>
<span class="w">  </span><span class="c">! declaring a function associated with the deferred type</span>
<span class="w">  </span><span class="k">function </span><span class="n">op</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">z</span>
<span class="w">  </span><span class="k">end function</span>
<span class="k">  function </span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">z</span>
<span class="w">  </span><span class="k">end function</span>
<span class="k">end </span><span class="n">requirement</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">monoid</span></code> requirement declares a deferred type <code class="docutils literal notranslate"><span class="pre">T</span></code> and two functions,<code class="docutils literal notranslate"><span class="pre">op</span></code> that takes arguments of type <code class="docutils literal notranslate"><span class="pre">T</span></code> and return a value with the same type <code class="docutils literal notranslate"><span class="pre">T</span></code> and <code class="docutils literal notranslate"><span class="pre">empty</span></code> that returns a value of type <code class="docutils literal notranslate"><span class="pre">T</span></code>. The deferred type <code class="docutils literal notranslate"><span class="pre">T</span></code> is internally interpreted as a variable <code class="docutils literal notranslate"><span class="pre">T</span></code> typed as <code class="docutils literal notranslate"><span class="pre">TypeParameter</span> <span class="pre">T</span></code> (for brevity we will write it just as <code class="docutils literal notranslate"><span class="pre">T</span></code>). Functions declared in requirements are abstract (without function body).</p>
<p>On ASR level, the requirement is represented by the symbol <a class="reference internal" href="../asr_nodes/symbol_nodes/Requirement/"><span class="doc std std-doc"><code class="docutils literal notranslate"><span class="pre">Requirement</span></code></span></a>. ASR for requirements are built during symbol table visit in the function <code class="docutils literal notranslate"><span class="pre">visit_Requirement</span></code>. <code class="docutils literal notranslate"><span class="pre">monoid</span></code>'s symbol table would contain a variable <code class="docutils literal notranslate"><span class="pre">T</span></code> with the type <code class="docutils literal notranslate"><span class="pre">T</span></code>, a function <code class="docutils literal notranslate"><span class="pre">op</span></code> with the type <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">*</span> <span class="pre">T</span> <span class="pre">-&gt;</span> <span class="pre">T</span></code>, and a function <code class="docutils literal notranslate"><span class="pre">empty</span></code> with the type <code class="docutils literal notranslate"><span class="pre">()</span> <span class="pre">-&gt;</span> <span class="pre">T</span></code>.</p>
<p>A requirement is checked to see if all the parameters have a corresponding symbol declared inside of it. A warning is generated if a parameter is declared but no symbol is found with the same name.</p>
<p>On its own, a requirement does not do any computation. It is also not compiled into the target language when the ASR is compiled.</p>
</section>
<section id="templates">
<h2 id="templates">Templates<a class="headerlink" href="#templates" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Templates take the role of a scope for generic functions. A template uses generic types and its associated type signatures obtained from requirements to check generic operations.</p>
<p>As a running example, we will consider a generic function for n-times multiplication for argument of any type. This function can be represented as:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">generics_example</span>
<span class="w">  </span><span class="c">! same requirement as before</span>
<span class="w">  </span><span class="n">requirement</span><span class="w"> </span><span class="n">monoid</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">empty</span><span class="p">)</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="k">end </span><span class="n">requirement</span>

<span class="w">  </span><span class="c">! the template starts from here</span>
<span class="w">  </span><span class="n">template</span><span class="w"> </span><span class="n">array_t</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">op_temp</span><span class="p">,</span><span class="w"> </span><span class="n">empty_temp</span><span class="p">)</span>
<span class="w">    </span><span class="n">require</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">monoid</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">op_temp</span><span class="p">,</span><span class="w"> </span><span class="n">empty_temp</span><span class="p">)</span>
<span class="w">  </span><span class="k">contains</span>
<span class="w">    </span><span class="c">! below is the generic function</span>
<span class="w">    </span><span class="k">function </span><span class="n">array_sum</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">      </span><span class="k">type</span><span class="p">(</span><span class="n">S</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arr</span><span class="p">(:)</span>
<span class="w">      </span><span class="k">type</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">r</span>
<span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>
<span class="w">      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="w">      </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">empty_temp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="w">          </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op_temp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">        </span><span class="k">end do</span>
<span class="k">      end if</span>
<span class="k">    end function</span>
<span class="k">  end </span><span class="n">template</span>
<span class="k">end module</span>
</pre></div>
</div>
<p>The template <code class="docutils literal notranslate"><span class="pre">array_t</span></code> contains the generic function <code class="docutils literal notranslate"><span class="pre">array_sum</span></code> that takes an array <code class="docutils literal notranslate"><span class="pre">arr</span></code> of type <code class="docutils literal notranslate"><span class="pre">S</span></code>. The template later on will be added to the parent symbol table as a <code class="docutils literal notranslate"><span class="pre">Template</span></code> symbol with the name <code class="docutils literal notranslate"><span class="pre">array_t</span></code>.</p>
<p>Typing context has to be obtained to type the parameter <code class="docutils literal notranslate"><span class="pre">arr</span></code> and the addition operation <code class="docutils literal notranslate"><span class="pre">op_temp(r,</span> <span class="pre">arr(i))</span></code>. Such typing context can be made available within the scope of the template by using a requirement. Here, the <code class="docutils literal notranslate"><span class="pre">Require</span></code> statement <code class="docutils literal notranslate"><span class="pre">require</span> <span class="pre">::</span> <span class="pre">monoid(S,</span> <span class="pre">op_temp,</span> <span class="pre">empty_temp)</span></code> builds the types of the template's parameters <code class="docutils literal notranslate"><span class="pre">S</span></code>, <code class="docutils literal notranslate"><span class="pre">op_temp</span></code>, and <code class="docutils literal notranslate"><span class="pre">empty_temp</span></code> based on the types of the symbols in <code class="docutils literal notranslate"><span class="pre">monoid</span></code>.</p>
<p>This corresponds to the <code class="docutils literal notranslate"><span class="pre">visit_UnitRequire</span></code> that can be found in <code class="docutils literal notranslate"><span class="pre">visit_Template</span></code> during symbol table visit. Calling a require statement copies the symbols from the requiremement and replaces their names with the argument names given by the require statement. In this case, the symbol <code class="docutils literal notranslate"><span class="pre">T</span></code>, <code class="docutils literal notranslate"><span class="pre">op</span></code>, and <code class="docutils literal notranslate"><span class="pre">empty</span></code> from the requirement <code class="docutils literal notranslate"><span class="pre">monoid</span></code> are replaced by <code class="docutils literal notranslate"><span class="pre">S</span></code>, <code class="docutils literal notranslate"><span class="pre">op_temp</span></code>, and <code class="docutils literal notranslate"><span class="pre">empty_temp</span></code> that are passed as arguments. This replacement is done by the function <code class="docutils literal notranslate"><span class="pre">rename_symbol</span></code>.</p>
<p>Eventually the require statement adds into <code class="docutils literal notranslate"><span class="pre">array_t</span></code>'s symbol table two symbols,  <code class="docutils literal notranslate"><span class="pre">S</span></code> as a variable with type <code class="docutils literal notranslate"><span class="pre">S</span></code>, <code class="docutils literal notranslate"><span class="pre">op_temp</span></code> and <code class="docutils literal notranslate"><span class="pre">empty_temp</span></code> as functions with types <code class="docutils literal notranslate"><span class="pre">S</span> <span class="pre">*</span> <span class="pre">S</span> <span class="pre">-&gt;</span> <span class="pre">S</span></code> and <code class="docutils literal notranslate"><span class="pre">()</span> <span class="pre">-&gt;</span> <span class="pre">S</span></code> based on <code class="docutils literal notranslate"><span class="pre">monoid</span></code>'s symbol table.</p>
<p>Symbol table visit checks the variable declarations in <code class="docutils literal notranslate"><span class="pre">array_sum</span></code>. Since <code class="docutils literal notranslate"><span class="pre">S</span></code> is available in the symbol table now, both variables <code class="docutils literal notranslate"><span class="pre">arr</span></code> and <code class="docutils literal notranslate"><span class="pre">r</span></code> can be typed. Later during body visit, with type <code class="docutils literal notranslate"><span class="pre">S</span></code>, <code class="docutils literal notranslate"><span class="pre">op_temp</span></code>, and <code class="docutils literal notranslate"><span class="pre">empty_temp</span></code> in the symbol table, the function call <code class="docutils literal notranslate"><span class="pre">op_temp(r,</span> <span class="pre">arr(i))</span></code> in <code class="docutils literal notranslate"><span class="pre">array_sum</span></code> would be checked in the same way as non-generic functions.</p>
<p>ASR representation of templates are also not compiled into the target language.</p>
</section>
<section id="instantiations">
<h2 id="instantiations">Instantiations<a class="headerlink" href="#instantiations" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Generic functions need to be instantiated with concrete types and functions to be used in run-time. The process of instantiation replaces the generic types in the function definition with concrete types (such as <code class="docutils literal notranslate"><span class="pre">integer</span></code>, <code class="docutils literal notranslate"><span class="pre">real</span></code>) and replace the abstract functions with implemented functions.</p>
<p>The generic function described in the previous section can be instantiated as a function that computes array sum by the following instantiation:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">functions</span>
<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">add_integer</span><span class="p">,</span><span class="w"> </span><span class="n">empty_integer</span>
<span class="k">contains</span>
<span class="k">  function </span><span class="n">add_integer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">add_integer</span>
<span class="w">    </span><span class="n">add_integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span>
<span class="w">  </span><span class="k">end function</span>
<span class="k">  function </span><span class="n">empty_integer</span><span class="p">()</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">empty_integer</span>
<span class="w">    </span><span class="n">empty_integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">end function</span>
<span class="k">end module</span>

<span class="k">program </span><span class="n">instantiate_template</span>
<span class="k">use </span><span class="n">functions</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">add_integer</span><span class="p">,</span><span class="w"> </span><span class="n">empty_integer</span>

<span class="n">instantiate</span><span class="w"> </span><span class="n">array_t</span><span class="p">(</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="n">add_integer</span><span class="p">,</span><span class="w"> </span><span class="n">empty_integer</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">  </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">array_sum_integer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array_sum</span>

<span class="c">! function argument for basic arithmetic operations can be replaced with an operator</span>
<span class="n">instantiate</span><span class="w"> </span><span class="n">array_t</span><span class="p">(</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="n">operator</span><span class="p">(</span><span class="o">+</span><span class="p">),</span><span class="w"> </span><span class="n">empty_integer</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">  </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">array_sum_integer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array_sum</span>

<span class="c">! eliding function renaming would instantiating all generic functions with the same name</span>
<span class="n">instantiate</span><span class="w"> </span><span class="n">array_t</span><span class="p">(</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="n">operator</span><span class="p">(</span><span class="o">+</span><span class="p">),</span><span class="w"> </span><span class="n">empty_integer</span><span class="p">)</span>
<span class="k">end program</span>
</pre></div>
</div>
<p>This instantiation statement</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instantiate</span> <span class="n">array_t</span><span class="p">(</span><span class="n">integer</span><span class="p">,</span> <span class="n">add_integer</span><span class="p">,</span> <span class="n">empty_integer</span><span class="p">),</span> <span class="n">only</span><span class="p">:</span> <span class="n">array_sum_integer</span> <span class="o">=&gt;</span> <span class="n">array_sum</span>
</pre></div>
</div>
<p>passes the type <code class="docutils literal notranslate"><span class="pre">integer</span></code>, an integer addition function <code class="docutils literal notranslate"><span class="pre">add_integer</span></code>, and a function describing empty integer value <code class="docutils literal notranslate"><span class="pre">empty_integer</span></code> as arguments to template <code class="docutils literal notranslate"><span class="pre">array_t</span></code>, then instantiates the function <code class="docutils literal notranslate"><span class="pre">array_sum</span></code> as a new function named <code class="docutils literal notranslate"><span class="pre">array_sum_integer</span></code>. This instantiation wants to replace <code class="docutils literal notranslate"><span class="pre">S</span></code> in <code class="docutils literal notranslate"><span class="pre">array_t</span></code> with the type <code class="docutils literal notranslate"><span class="pre">integer</span></code>, <code class="docutils literal notranslate"><span class="pre">op_temp</span></code> function calls with <code class="docutils literal notranslate"><span class="pre">add_integer</span></code> function calls, and <code class="docutils literal notranslate"><span class="pre">empty_temp</span></code> function calls with <code class="docutils literal notranslate"><span class="pre">empty_integer</span></code> function calls.</p>
<section id="type-checking">
<h3 id="type-checking">Type Checking<a class="headerlink" href="#type-checking" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Before a function is generated on ASR level by an instantiation, the compiler checks the consistency of its type substitution based on the given symbol arguments. Currently there is no notion of subtyping in LFortran, so checking is limited to exact type checks. This is done by tracking the type substitutions made by the symbol arguments and rejecting any contradicting type subsitutition. Checking is done during symbol table visit in <code class="docutils literal notranslate"><span class="pre">visit_Instantiate</span></code>.</p>
<p>We will explain this in detail through the instantiation example above. The first argument <code class="docutils literal notranslate"><span class="pre">integer</span></code> substitutes the type parameter <code class="docutils literal notranslate"><span class="pre">S</span></code> in template <code class="docutils literal notranslate"><span class="pre">array_t</span></code> (maps <code class="docutils literal notranslate"><span class="pre">S</span></code> to <code class="docutils literal notranslate"><span class="pre">integer</span></code>). The second argument <code class="docutils literal notranslate"><span class="pre">add_integer</span></code> substitutes the type <code class="docutils literal notranslate"><span class="pre">S</span> <span class="pre">*</span> <span class="pre">S</span> <span class="pre">-&gt;</span> <span class="pre">S</span></code> of <code class="docutils literal notranslate"><span class="pre">op_temp</span></code> with <code class="docutils literal notranslate"><span class="pre">integer</span> <span class="pre">*</span> <span class="pre">integer</span> <span class="pre">-&gt;</span> <span class="pre">integer</span></code> (checks <code class="docutils literal notranslate"><span class="pre">S</span></code> substitution). This is allowed because the function argument gives a consistent substitution with the previous argument. If it passes the type checks, the instantiated function would be generated as a function on ASR level. Successfully checked symbol arguments are put inside the variable <code class="docutils literal notranslate"><span class="pre">type_subs</span></code> for type substitution (<code class="docutils literal notranslate"><span class="pre">S</span></code> to <code class="docutils literal notranslate"><span class="pre">integer</span></code>) and <code class="docutils literal notranslate"><span class="pre">symbol_subs</span></code> for function substitution (<code class="docutils literal notranslate"><span class="pre">op_temp</span></code> to <code class="docutils literal notranslate"><span class="pre">add_integer</span></code>).</p>
<p>Now, suppose that we have the following instantiation where instead of <code class="docutils literal notranslate"><span class="pre">integer</span></code>, we pass <code class="docutils literal notranslate"><span class="pre">real</span></code> as an argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instantiate</span> <span class="n">array_t</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">add_integer</span><span class="p">,</span> <span class="n">empty_integer</span><span class="p">),</span> <span class="n">only</span><span class="p">:</span> <span class="n">array_sum_integer</span> <span class="o">=&gt;</span> <span class="n">array_sum</span>
</pre></div>
</div>
<p>Here, the first type argument maps <code class="docutils literal notranslate"><span class="pre">S</span></code> to <code class="docutils literal notranslate"><span class="pre">real</span></code> but the second function argument maps <code class="docutils literal notranslate"><span class="pre">S</span></code> to <code class="docutils literal notranslate"><span class="pre">integer</span></code>, resulting in a contradiction. Hence ending in a type error.</p>
<p>This check is tracked by the two variables <code class="docutils literal notranslate"><span class="pre">type_subs</span></code> and <code class="docutils literal notranslate"><span class="pre">symbol_subs</span></code>. Function arguments are checked by the function <code class="docutils literal notranslate"><span class="pre">check_restriction</span></code> during symbol table visit.</p>
<p><strong>Handling Operator Arguments</strong></p>
<p>Instantiations can be made simpler for basic binary operations (addition, multiplication, etc.) by passing <code class="docutils literal notranslate"><span class="pre">operator(&lt;sign&gt;)</span></code> instead of pre-defined functions.</p>
<p>If the type substitution tracked by <code class="docutils literal notranslate"><span class="pre">type_subs</span></code> is consistent for a binary arithmetic operation, then a function is implicitly generated as a function argument. From the example before, we will have a function that is equivalent to the following LFortran function generated implicitly:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span>function ~add_intrinsic(arg0, arg1) result(ret)
  integer, intent(in) :: arg0, arg1
  integer :: ret
  ret = arg0 + arg1
end function
</pre></div>
</div>
</section>
<section id="asr-generation">
<h3 id="asr-generation">ASR Generation<a class="headerlink" href="#asr-generation" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Instantiating the function as a function on the ASR level is simply a symbol replacement process.</p>
<p>The generation process is split into two, generating the function signature during symbol table visit and generating the function body during body visit. The whole generation is not done during body visit because derived types generated from a template may be used to type variable declarations.</p>
<p>During symbol table visit, after checking arguments and placing the symbol substitution into <code class="docutils literal notranslate"><span class="pre">type_subs</span></code> and <code class="docutils literal notranslate"><span class="pre">symbol_subs</span></code>, the instantiated function is added into the symbol table and its signature is built by the function <code class="docutils literal notranslate"><span class="pre">instantiate_symbol</span></code> where the deferred types are replaced with concrete types. For the example above, a function equivalent to the following is generated:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">elemental function </span><span class="n">array_sum_integer</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arr</span><span class="p">(:)</span><span class="w">   </span><span class="c">! type replaced</span>
<span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">r</span><span class="w">                    </span><span class="c">! type replaced</span>
<span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>
<span class="k">end function</span>
</pre></div>
</div>
<p>The substitution in <code class="docutils literal notranslate"><span class="pre">type_subs</span></code> and <code class="docutils literal notranslate"><span class="pre">symbol_subs</span></code> are preserved and then passed to the body visitor. During body visit, the body of the instantiated function is built in <code class="docutils literal notranslate"><span class="pre">visit_Instantiate</span></code> by the function <code class="docutils literal notranslate"><span class="pre">instantiate_body</span></code>, replacing any abstract functions with concrete functions:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">array_sum_integer</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arr</span><span class="p">(:)</span>
<span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">r</span>
<span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>
<span class="w">  </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="w">  </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">empty_integer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w">              </span><span class="c">! function call replaced</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="w">      </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_integer</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w">  </span><span class="c">! function call replaced</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">  end if</span>
<span class="k">  end do</span>
<span class="k">end function</span>
</pre></div>
</div>
</section>
</section>
<section id="see-also">
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../programming_generics/"><span class="doc std std-doc">Programming With Generics</span></a>, for simpler explaining about using generics in LFortran</p></li>
</ul>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2022 LFortran contributors.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>